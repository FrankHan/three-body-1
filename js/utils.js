////////////////////////////////////////////////////////////////////////////////
// utils
// functions not fit in other places
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// rotateOnWorldAxis
////////////////////////////////////////////////////////////////////////////////

THREE.Object3D.prototype.currentMatrixWorld = function(){
  var m = new THREE.Matrix4().copy(this.matrix);
  var parent;
  while (parent = this.parent)
  {
    m.multiply(parent.matrix);
  }
  return m;
}


////////////////////////////////////////////////////////////////////////////////
// rotateOnWorldAxis
////////////////////////////////////////////////////////////////////////////////

THREE.Object3D.prototype.rotateOnWorldAxis = function(axis, angle){
  this.matrixWorldNeedsUpdate = true;
  var rotation = new THREE.Matrix4();
  rotation.extractRotation(this.matrixWorld);
  var matrix = new THREE.Matrix4();
  matrix.getInverse(rotation);
  axis.applyMatrix4(matrix);
  this.rotateOnAxis( axis, angle );
}

////////////////////////////////////////////////////////////////////////////////
// rotateXY
////////////////////////////////////////////////////////////////////////////////

THREE.Object3D.prototype.rotateXY = function(deltaVector) {
  var up = new THREE.Vector3( 0, 1, 0 );
  var left = new THREE.Vector3( 1, 0, 0);
  this.rotateOnWorldAxis( up, deltaVector.x );
  this.rotateOnWorldAxis( left, deltaVector.y );
}

////////////////////////////////////////////////////////////////////////////////
// log
////////////////////////////////////////////////////////////////////////////////

function log(msg) {
    setTimeout(function() {
        throw new Error(msg);
    }, 0);
}

////////////////////////////////////////////////////////////////////////////////
// randRange
// returns a number between [min, max)
////////////////////////////////////////////////////////////////////////////////

function randRange(min, max)
{
  return Math.random() * (max - min) + min;
}

////////////////////////////////////////////////////////////////////////////////
// randVector3
// returns a Vector3 with randomized xyz
////////////////////////////////////////////////////////////////////////////////

function randVector3(min, max)
{
  return new THREE.Vector3(randRange(min, max), randRange(min, max), randRange(min, max));
}

////////////////////////////////////////////////////////////////////////////////
// addRandFactor
////////////////////////////////////////////////////////////////////////////////

THREE.Vector3.prototype.addRandFactor = function(factor)
{
  var range = this.length() * factor;
  this.add(randVector3(-range, range));
}

////////////////////////////////////////////////////////////////////////////////
// get a perpendicular vector
////////////////////////////////////////////////////////////////////////////////

function getPerpendicular(vector)
{
  var result = new THREE.Vector3();
  result.crossVectors(vector, new THREE.Vector3(0, 1, 0));
  if (result.lengthSq() == 0)
    result.crossVectors(vector, new THREE.Vector3(0, 0, 1)); // try a different axis
  return result;
}